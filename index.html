<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Visual LED Controller</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f0f2f5; padding: 20px; }
        #webcam-container { margin: 20px auto; border: 8px solid #ffffff; width: 240px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden; }
        #label-container div { font-size: 1.1rem; margin: 8px auto; padding: 12px; width: 280px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        button { padding: 12px 24px; font-size: 1rem; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <h2>AI Visual LED Controller</h2>
    <button type="button" onclick="init()">ðŸš€ Start System</button>
    
    <div id="webcam-container"></div>
    <div id="label-container"></div>

    <script src="https://cdn.jsdelivr.net"></script>
    <script src="https://cdn.jsdelivr.net"></script>

    <script type="text/javascript">
        // 1. CONFIGURATION
        const URL = "./my_model/"; 
        const ESP32_IP = "http://10.169.19.1"; // Replace with your ESP32's IP address
        
        let model, webcam, labelContainer, maxPredictions;
        let lastState = ""; // Tracks state to avoid spamming the ESP32

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = true; 
            webcam = new tmImage.Webcam(240, 240, flip); 
            await webcam.setup(); 
            await webcam.play();
            window.requestAnimationFrame(loop);

            document.getElementById("webcam-container").appendChild(webcam.canvas);
            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
        }

        async function loop() {
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            
            for (let i = 0; i < maxPredictions; i++) {
                const className = prediction[i].className;
                const probability = prediction[i].probability.toFixed(2);
                labelContainer.childNodes[i].innerHTML = `<b>${className}</b>: ${Math.round(probability * 100)}%`;

                // 2. TRIGGER LOGIC
                // Make sure "LED_ON" and "LED_OFF" match your Teachable Machine class names exactly
                if (className === "LED_ON" && probability > 0.95 && lastState !== "ON") {
                    controlESP32("on");
                    lastState = "ON";
                } else if (className === "LED_OFF" && probability > 0.95 && lastState !== "OFF") {
                    controlESP32("off");
                    lastState = "OFF";
                }
            }
        }

        function controlESP32(state) {
            console.log("Triggering ESP32: " + state);
            // 'no-cors' is used to prevent security blocks on local network requests
            fetch(`${ESP32_IP}/led/${state}`, { mode: 'no-cors' })
                .catch(e => console.error("WiFi Error: Check if ESP32 is online."));
        }
    </script>
</body>
</html>
